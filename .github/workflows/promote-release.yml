name: Promote Release (Public Mirror)

# ============================================================================
# Plugin Configuration
# ============================================================================
env:
  PLUGIN_NAME: "Influx"

# Triggered by Influx-private via repository_dispatch after promoting a testing release
on:
  repository_dispatch:
    types: [promote-release]

permissions:
  contents: write

jobs:
  # ================================================================
  # Promote: flip prerelease flag on a mirrored release
  # ================================================================
  promote:
    if: github.event.action == 'promote-release'
    runs-on: ubuntu-latest
    steps:
      - name: Promote pre-release to full release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ github.event.client_payload.version }}"
          TAG="v${VERSION}"

          echo "Promoting ${TAG} from pre-release to stable..."

          # Get the release by tag
          RELEASE_ID=$(gh api "repos/${{ github.repository }}/releases/tags/${TAG}" --jq '.id' 2>/dev/null)
          if [ -z "$RELEASE_ID" ]; then
            echo "Error: Release ${TAG} not found"
            exit 1
          fi

          # Determine if this version should be marked as Latest
          MAKE_LATEST="true"
          CURRENT_LATEST=$(gh api "repos/${{ github.repository }}/releases/latest" --jq '.tag_name // ""' 2>/dev/null || echo "")
          if [ -n "$CURRENT_LATEST" ]; then
            NEW_VER="${TAG#v}"; NEW_VER="${NEW_VER%%-*}"
            CUR_VER="${CURRENT_LATEST#v}"; CUR_VER="${CUR_VER%%-*}"
            IFS='.' read -r NEW_MAJOR NEW_MINOR NEW_PATCH <<< "$NEW_VER"
            IFS='.' read -r CUR_MAJOR CUR_MINOR CUR_PATCH <<< "$CUR_VER"
            NEW_MAJOR=${NEW_MAJOR:-0}; NEW_MINOR=${NEW_MINOR:-0}; NEW_PATCH=${NEW_PATCH:-0}
            CUR_MAJOR=${CUR_MAJOR:-0}; CUR_MINOR=${CUR_MINOR:-0}; CUR_PATCH=${CUR_PATCH:-0}
            if [ "$NEW_MAJOR" -lt "$CUR_MAJOR" ] || \
               ([ "$NEW_MAJOR" -eq "$CUR_MAJOR" ] && [ "$NEW_MINOR" -lt "$CUR_MINOR" ]) || \
               ([ "$NEW_MAJOR" -eq "$CUR_MAJOR" ] && [ "$NEW_MINOR" -eq "$CUR_MINOR" ] && [ "$NEW_PATCH" -le "$CUR_PATCH" ]); then
              MAKE_LATEST="false"
              echo "Version $TAG is not higher than current latest $CURRENT_LATEST, will not mark as latest"
            fi
          fi

          # Flip the prerelease flag and update title/notes
          gh api "repos/${{ github.repository }}/releases/${RELEASE_ID}" \
            --method PATCH \
            -f name="${{ env.PLUGIN_NAME }} v${VERSION}" \
            -f body="## ${{ env.PLUGIN_NAME }} v${VERSION}

          Promoted from testing release.

          ### Installation Files
          - \`latest.zip\` - **Plugin archive for installation**
          - \`${{ env.PLUGIN_NAME }}.json\` - Plugin manifest" \
            -F prerelease=false \
            -f make_latest="$MAKE_LATEST"

          echo "Successfully promoted ${TAG} to stable (download counts preserved, make_latest=$MAKE_LATEST)"
